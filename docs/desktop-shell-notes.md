# 桌面壳探索笔记

本文整理了围绕「AgentDev 是否要做桌面壳（Electron、Tauri 等）」的讨论，供后续真正实施时参考。

## 当前架构速览

- AgentDev 本体是一个 Rust CLI，内置 Axum Web 服务器。当设置 `AGENTDEV_SKIP_UI_BUILD=0` 时，服务器会嵌入编译后的 Next.js UI，并在 `/api/*` 下暴露 REST/WebSocket 接口。
- 长任务依靠 git worktree、tmux 会话和外部 Agent 进程完成。CLI 的 `agentdev worktree exec`（`src/commands/exec.rs`）支持在 worktree 内执行任意命令，将元数据写入 `processes.json`，并把 stdout/stderr 直接流给调用者。
- Web 仪表盘通过 `POST /api/worktrees/{id}/commands` 复用同一套执行链路。后端拉起子进程、采集输出并记录，UI 完成后再展示；交互式终端体验目前仍由 tmux 提供，浏览器只负责渲染捕获到的内容。

## 为什么考虑桌面壳

- **一键启动体验**：打包单个应用即可启动后端、打开 UI，不再要求用户提前安装 Rust、pnpm、tmux。
- **系统能力接入**：桌面壳可以访问原生通知、全局快捷键、托盘、拖拽、文件选择器、自动更新等浏览器受限能力。
- **定位升级**：可以把 AgentDev 作为常驻桌面伙伴，而不仅是命令行工具。

## 架构选项

### 1. 桌面壳 + 本地服务器（薄壳模式）

- 将 `agentdev` 与轻量壳一起打包。壳启动时先拉起 Rust 后端（即现有二进制），监听本地端口，再通过 WebView 加载现有 UI。
- 优势：
  - 对现有后端 / exec / tmux 链路几乎零改动。
  - 维持跨平台一致性（后端照常调用 tmux/git/Command）。
  - 实现「双击图标即可使用」的成本最低。
- 注意事项：
  - 进程生命周期管理（壳退出要带走后端、处理异常崩溃）。
  - 端口冲突处理（探测、兜底报错）。
  - 分发成本：代码签名、notarization、安装包制作。
  - 原生能力仍需壳额外开放 API，后端只提供现有能力。

### 2. 全原生执行层（类 VS Code 模式）

- 在壳内嵌 PTY 实现（node-pty、tauri-plugin-shell 或自研 Rust 层），直接管理 git/agent 进程，而不是依赖 tmux。
- 优势：
  - 终端能力完全掌控，可脱离 tmux，打造更强的终端体验。
  - UI 与系统 API 可直接通信，不必经后端转发。
- 注意事项：
  - 维护成本高：需处理跨平台 PTY、信号、编码、窗口 resize 等细节。
  - 安全边界与权限提示需要重新设计（Electron/Tauri 常需关闭严格沙箱，类似 VS Code）。
  - 需要重新规划 `process_registry`、exec 历史，确保 CLI 与桌面壳共享一致状态。

## 对 exec / 进程处理的影响

- CLI 版 exec 已经支持实时输出和交互；Dashboard 版本会缓冲到结束。桌面化前应先决定是否要支持 UI 流式展示，这与壳选择无关。
- 若采用薄壳策略，exec 实现可保持不变，只需在桌面 UI 展示进程概览。
- 若改为原生 PTY，需要重写 stdout/stderr 流式和交互输入，并给 CLI 用户提供向后兼容方案（他们习惯了 tmux）。

## 原生能力桥接

- 桌面壳可以直接提供通知、全局快捷键、自启动、拖拽、系统对话框等能力。可与现有后端并存：业务逻辑仍走后端，壳额外暴露针对原生能力的 API。
- 任何涉及系统权限的指令（打开文件、启动编辑器等）都需要机制化的安全提示。能力越多，信任、签名、用户确认就越重要。

## 风险与运维考量

- **安全**：打包应用执行任意命令需建立明确的权限模型，尤其是将来发布二进制后面对大众用户时。
- **跨平台支持**：tmux 在 macOS/Linux 标配，但 Windows 缺失；桌面化可能迫使我们提供 Windows 替代方案（wezterm、ConPTY、自研 PTY 等）。
- **发布流水线**：Electron 体积大但生态全；Tauri 轻量但依赖插件。无论哪种，都要解决签名、notarization、自动更新托管、发行流程。
- **维护成本**：同时维护 CLI、浏览器 UI、桌面 UI 容易分裂，需要清晰的分层设计避免重复造轮子。

## 推荐推进路径

1. 先做薄壳原型（Tauri 体积小或 Electron 生态成熟）：
   - 打包现有后端。
   - 启动时拉起服务器并将 UI 嵌入 WebView。
   - 重点验证后端生命周期与端口协商的健壮性。
2. 评估原生能力诉求是否足够强。如有需要，再逐步加入壳侧 API（通知、托盘、文件对话框等），业务逻辑仍交给后端处理。
3. 只有在明确需要脱离 tmux、实现实时终端流等需求时，才考虑投入原生 PTY/命令执行层，并设计可供 CLI 与桌面共用的统一抽象。

## 后续问题

- 是否预计 Windows 用户规模足够大，从而必须摆脱 tmux？
- 哪些原生功能值得我们承担额外维护成本（自动更新、托盘、快捷键录制等）？
- CLI 与桌面壳共享配置时，是否沿用同一配置目录，还是各自维护副本？
- 桌面壳发起的 exec 记录能否复用现有 `process_registry`，还是需要同步机制？

未来规划 Electron/Tauri 路线时，可回到这份笔记，帮助我们评估工程投入与运维成本。
